---
title: "Data analysis - Producing insight from WAStD"
author: "Florian Mayer, Flatbacks WA"
date: "`r Sys.time()`"
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{Data analysis}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(wastdr)
library(dplyr)
library(magrittr)
library(skimr)
library(leaflet)
library(lubridate)
library(listviewer)
library(DT)
library(ggplot2)
```
# Data
This section illustrates how to access data, and defines helper methods to 
filter, map, summarise, and plot data.

Once refined, these helper functions will become core `wastdr` functionality.

## Caveat
* The data as shown is still pre-QA until this message disappears.
* Usernames (hidden here for privacy, but in WAStD) are still hilariously wrong
  after matching the usernames as submitted to the actual usernames in WAStD.


## Load data
```{r load_data, echo=T}
if (file.exists("~/tracks.Rda")){
load("~/tracks.Rda")
} else {
track_records <- wastdr::get_wastd("turtle-nest-encounters")
save(track_records, file = "~/track_records.Rda")
load("~/track_records.Rda")
# listviewer::jsonedit(utils::head(track_records$features))
tracks <- parse_turtle_nest_encounters(track_records)
save(tracks, file = "~/tracks.Rda")
}
```

## Filter data
To filter records to one area, we can either filter by area or site ID 
(once enabled), or simply filter by a bounding box. 
Additionaly, we'll filter by date.

In this example, we'll filter to an area surveyed by the West Pilbara Turtle 
Program.

```{r filter_data}
species_colours <- tibble::tibble(
    species = c(
    "cheloniidae-fam",
    "chelonia-mydas",
    "eretmochelys-imbricata",
    "natator-depressus",
    "corolla-corolla",
    "lepidochelys-olivacea",
    "caretta-caretta"    
    ),
    species_colours = c(
    "gray",
    "green",
    "darkblue",
    "beige",
    "pink",
    "darkgreen",
    "orange"
    )
)

nest_type_text <- tibble::tibble(
    nest_type = c(
        "hatched-nest", 
        "successful-crawl",
        "track-not-assessed",
        "track-unsure",
        "nest",
        "false-crawl"),
    nest_type_text = c(
        "NH", 
        "N",
        "T+?",
        "N?",
        "N",
        "T")
)


add_lookups <- . %>% 
    left_join(species_colours, by="species") %>%
    left_join(nest_type_text, by="nest_type")

filter_2017 <- . %>% dplyr::filter(date > dmy("17/11/2017")) %>% add_lookups

# Broome Cable Beach BCB
filter_broome <- . %>% dplyr::filter(
    longitude > 122.19749450683595,
    longitude < 122.21878051757814,
    latitude > -17.98003932552008,
    latitude < -17.807533645104847)

# Eighty Mile Beach
filter_eighty_mile_beach <- . %>% dplyr::filter(
    longitude > 119.44885253906251,
    longitude < 121.563720703125,
    latitude > -20.159098270646922,
    latitude < -18.994608853186367)

# Pt Hedland (bbox includes town, could contain training data)
filter_port_hedland <- . %>% dplyr::filter(
    longitude > 118.57269287109375,
    longitude < 118.6458206176758,
    latitude > -20.315974678018147,
    latitude < -20.293354957050294)

# West Pilbara (Wickam Yacht Club and Bell's Beach)
filter_west_pilbara <- . %>% dplyr::filter(
    longitude > 117.0, 
    longitude < 117.3, 
    latitude >  -20.7,
    latitude <  -20.5) 

# Thevenard Island
filter_thevenard <- . %>% dplyr::filter(
    longitude > 114.96437072753908,
    longitude < 115.03363609313966,
    latitude > -21.470242707163145,
    latitude < -21.444920225158263)
```


## Map data

```{r, eval=T}
tracks_map <- function(track_data) {
    l <- leaflet(width=800, height=600) %>% 
        addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
        addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
        clearBounds()

    tracks.df <-  track_data %>% split(track_data$species)
    
    names(tracks.df) %>%
        purrr::walk( function(df) {
            l <<- l %>%
                addAwesomeMarkers(
                    data = tracks.df[[df]],
                    lng = ~longitude, lat=~latitude,
                    icon = leaflet::makeAwesomeIcon(
                        text = ~nest_type_text,
                        markerColor = ~species_colours),
                    label=~paste(date, nest_age, species, nest_type),
                    popup=~paste(date, nest_age, species, nest_type),
                    group = df
                )
        })
    
    l %>%
        addLayersControl(
            baseGroups = c("Aerial", "Place names"),
            overlayGroups = names(tracks.df),
            options = layersControlOptions(collapsed = FALSE)
        )
}
```


## Summarise and plot data
Data (all tracks or filtered subsets) are filtered to only fresh observations,
then grouped and tallied by date, species and type.

Daily summaries are shown in wide form as tables, and (using long form) as 
timeseries plots.

```{r data_wp_daily}
daily_species_by_type <- . %>% 
    filter(nest_age=="fresh") %>%
    group_by(date, species, nest_type) %>% 
    tally() %>%
    ungroup()

daily_summary <- . %>% 
    daily_species_by_type %>% 
    tidyr::spread(nest_type, n, fill=0) %>%
    DT::datatable(.)

tracks_ts <- . %>% 
    daily_species_by_type %>% 
    {ggplot(data=., aes(x = date, y = n, colour = nest_type)) + 
            geom_point() + 
            # geom_smooth(method = "auto") +
            geom_line() +
            scale_x_date(breaks = scales::pretty_breaks(),
                         labels = scales::date_format("%d %b %Y")) +
            xlab("Date") +
            ylab("Number counted per day") +
            ggtitle("Nesting activity") +
            theme_light()}
```

# Nesting activity
This chapter uses the data and helpers from the above section and provides some
insight into the different regions.

This section is by no means complete and can be extended as appropriate.

## Overall
```{r, fig.width=7, fig.height=5}
tracks %>% add_lookups %>% tracks_map
```

## Broome Cable Beach 
```{r, fig.width=7, fig.height=5}
tracks_cbb <- tracks %>% filter_2017 %>% filter_broome
tracks_cbb %>% tracks_map
tracks_cbb %>% DT::datatable(.)
tracks_cbb %>% daily_summary
tracks_cbb %>% tracks_ts
```

## Eighty Mile Beach
```{r, fig.width=7, fig.height=5}
tracks_emb <- tracks %>% filter_2017 %>% filter_eighty_mile_beach
tracks_emb %>% tracks_map
tracks_emb %>% DT::datatable(.)
tracks_emb %>% daily_summary
tracks_emb %>% tracks_ts
```

## Port Hedland
```{r, fig.width=7, fig.height=5}
tracks_pth <- tracks %>% filter_2017 %>% filter_port_hedland
tracks_pth %>% tracks_map
tracks_pth %>% DT::datatable(.)
tracks_pth %>% daily_summary
tracks_pth %>% tracks_ts
```

## West Pilbara Turtle Program

```{r, fig.width=7, fig.height=5}
tracks_wp <- tracks %>% filter_2017 %>% filter_west_pilbara
tracks_wp %>% tracks_map
tracks_wp %>% DT::datatable(.)
tracks_wp %>% daily_summary
tracks_wp %>% tracks_ts
```

## Thevenard Island
```{r, fig.width=7, fig.height=5}
tracks_thv <- tracks %>% filter_2017 %>% filter_thevenard
tracks_thv %>% tracks_map
tracks_thv %>% DT::datatable(.)
tracks_thv %>% daily_summary
tracks_thv %>% tracks_ts
```
