---
title: "Data analysis - Producing insight from WAStD"
author: "Florian Mayer, North West Shelf Flatbacks WA"
date: "`r Sys.time()`"
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{Data analysis}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
library(wastdr)
library(dplyr)
library(tidyr)
library(magrittr)
library(skimr)
library(leaflet)
library(lubridate)
library(listviewer)
library(DT)
library(ggplot2)
wastdr::wastdr_setup()
# wastdr::wastdr_settings()
```
# Data
This section illustrates how to access data, and defines helper methods to 
filter, map, summarise, and plot data.

Once refined, these helper functions will become core `wastdr` functionality.

## Caveat
* The data as shown is still pre-QA until this message disappears.
* Usernames are still hilariously wrong after matching the usernames 
  (as submitted) to the actual usernames in WAStD. See the field `commments` for
  QA messages.

## Load data
```{r load_data, echo=T}
if (file.exists("tracks.Rda")){
    load("tracks.Rda")
} else {
    q = list(observer=4, format = "json")
    track_records <- wastdr::wastd_GET("turtle-nest-encounters", query=q)
    tracks <- parse_turtle_nest_encounters(track_records)
    disturbance_records <- wastdr::wastd_GET("disturbance-observations", query=q)
    disturbance <- disturbance_records %>% wastdr::parse_disturbance_observations()
    survey_records <- wastdr::wastd_GET("surveys", query=list(reporter=4, format = "json"))
    surveys <- survey_records %>% parse_surveys()
    nest_records <- wastdr::wastd_GET("nesttag-observations", query=q)
    nests <- nest_records %>% wastdr::parse_nesttag_observations()
    save(
      track_records, 
      tracks, 
      survey_records, 
      surveys, 
      disturbance_records, 
      disturbance, 
      nest_records, 
      nests, 
      file = "tracks.Rda"
    )
}
```

## Filter data
To filter records to one area, we can either filter by area or site ID 
(once enabled), or simply filter by a bounding box. 
Additionaly, we'll filter by date.

Site names and IDs are only correct at the time of writing. As they could change, please
double-check the correct spelling of your own place names and their IDs in WAStD.

```{r filter_data}
tracks_2017 <- tracks %>% dplyr::filter(season==2017)
```

# Turtle Tracks and Nests
This section demonstrates the summary and visualisation utilities for tracks.

The data shown here will make absolutely no sense, as it contains training and dummmy data.

## Maps
Each track on the map has a popup with a link to the actual record on WAStD.
Accessing and editing the record is restricted to authorised DBCA staff members.

Map markers can be grouped or not. 

Non-grouped markers show the actual location more accurately, but can overlap to
the point where it is not possible to open the popups. 

Grouped markers in densely populated locations will expand to prevent the overlap of
markers and popups.

Use "Place names" where the aerial imagery is not available at the zoom level required
for the grouped markers to expand.
```{r tracks_maps}
tracks %>% add_nest_labels() %>% map_tracks()
tracks %>% add_nest_labels() %>% map_tracks(cluster=T)
```


## Nesting success - tracks with nest vs the rest
Overview tables are available for the most common summaries at the most common
groupings (season, week, day / area, site).

```{r tracks_ns}
tracks %>% nesting_type_by_season_species()
tracks %>% nesting_type_by_area_season_species()
tracks %>% nesting_type_by_site_season_species()
tracks %>% nesting_type_by_season_week_species()
tracks %>% nesting_type_by_season_day_species()

# Track success by day and species
tracks %>% track_success()

# Track success by species
tracks %>% track_success() %>% track_success_by_species()

tracks %>% track_success %>% 
  ggplot_track_success_by_date("natator-depressus", placename="Test place", prefix="TEST")

tracks %>% track_success %>% 
  ggplot_track_successrate_by_date("natator-depressus", placename="Test place", prefix="TEST")
```

## Nest excavations: Hatching and emergence success

```{r tracks_hses}
tracks %>% hatching_emergence_success()
tracks %>% hatching_emergence_success_area()
tracks %>% hatching_emergence_success_site()
```

## Tagged nests
```{r taggee_nests}
nests %>% map_nests()
```


## Disturbed nests
```{r dist_nests}
tracks %>% dplyr::filter(disturbance == "present") %>% add_nest_labels() %>% map_tracks()
tracks %>% dplyr::filter(disturbance == "present") %>% add_nest_labels() %>% map_tracks(cluster=T)
```


# Disturbances and predation
```{r}
disturbance %>% disturbance_by_season()
disturbance %>% map_dist()
disturbance %>% map_dist(cluster=T)
```


# Surveys
```{r surveys}
surveys %>% survey_count()
surveys %>% surveys_per_site_name_and_date()
surveys %>% survey_hours_per_site_name_and_date()
surveys %>% survey_hours_per_person()
surveys %>% list_survey_count()
surveys %>% plot_survey_count()
surveys %>% list_survey_effort()
surveys %>% plot_survey_effort()
surveys %>% survey_hours_heatmap(placename = "All the places", prefix = "TEST")
surveys %>% survey_count_heatmap(placename = "All the places", prefix = "TEST")
surveys %>% survey_season_stats()
surveys %>% survey_season_site_stats()
surveys %>% survey_show_detail() %>% DT::datatable(escape = F)
```

# QA

Coming soon.
